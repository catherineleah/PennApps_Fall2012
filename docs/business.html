<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>TruckMeNow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Finding food trucks near you!">
    <meta name="author" content="Joel Goldman, Catherine Hu, Elissa Wolf, Dan Judd">

    <!-- Le styles -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="assets/css/docs.css" rel="stylesheet">
    <link href="assets/js/google-code-prettify/prettify.css" rel="stylesheet">
    <link href="assets/css/jquery-ui.css" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/cloudmine.js"></script>
    <link rel="stylesheet" href="assets/css/font-awesome.css">


    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">

  </head>

  <body data-spy="scroll" data-target=".bs-docs-sidebar" style='padding:0px;margin:0px;'>

    <!-- Navbar
    ================================================== -->
  <div id="business" style='width:100%;margin-top:-10px;'>
  </div>

<style type='text/css'>
  .bizheader{
    margin:0px;
    padding:13px 18px 5px 18px; 
    background-color:#88DD77;
    border-bottom:1px solid #DDD;
  }
  .bizsection{
    margin:0px;
    padding:20px 20px;
    background-color:#fff;
    opacity:0.9;
    border:0px;
  }
  .bizline{
    border-bottom:1px solid #DDD;
  }
  .bizsection a:hover{
      text-decoration:none;
  }
</style>

<script type="text/javascript">


  function prepareToGetFood(foursquareId) { 
    findBusiness(foursquareId, 39.953323, -75.201333);
    /*
    navigator.geolocation.getCurrentPosition(GetLocation);
      function GetLocation(location) {
        var lat = location.coords.latitude;
        var lng = location.coords.longitude;
        globalLat = lat;
        globalLng = lng;
        findFoodNearMe(lat, lng);
      }
  */
  }



  function findBusiness(foursquareId, lat, lng) {
    ll = lat + "," + lng;
    $.ajax({
      async: false,
      url: "https://api.foursquare.com/v2/venues/" + foursquareId,
      dataType: "json",
      data: {
        ll: ll,
        client_id: "1RZ3PLTJPBAYOY4KEJDJIEUPM3CCJFRB22P3JYQZA3JCPE0Z",
        client_secret: "FDCYFIMGAQGVHNVIZ5XSHLMQCYLSCKELUPEBSB3K5TYUTNRW",
        v: "20120822"
      },
      success: function(data) {
        displayBusiness(data.response.venue);
      }
    });
  }

  function displayMenu(venue){
      var distanceMiles = Math.round(0.000621371 * venue.location.distance * 100) / 100;
      var menudisplay = 
        "<div class='bizheader'>" +
          "<div style='float:right;margin-top:22px;width:auto;'><i class='icon-map-marker'></i> " + distanceMiles + " mi.</div>" + 
          "<h3 style='text-shadow:-1px 1px 0px #9e9;'>" + venue.name + " Menu</h3>" +
        "</div>";
      $('#menu').append(menudisplay);
  }

  function displayBusiness(venue) {
    var distanceMiles = Math.round(0.000621371 * venue.location.distance * 100) / 100;
    var business =
      "<div class='bizheader'>" +
        "<div style='float:right;margin-top:22px;width:auto;'><i class='icon-map-marker'></i> " + distanceMiles + " mi.</div>" + 
        "<h3 style='text-shadow:-1px 1px 0px #9e9;'>" + venue.name + "</h3>" +
      "</div>";
      
    getCategory(venue.id, function(category) {
    	if (category == -1){ //No category found
    		business +=
        "<div class='bizsection bizline'>" +
          "<span><a href='notRightCategory()'><em>What kind of place is this?</em></a></span>" +
        "</div>";
    	} else {
    		business += 
        "<div class='bizsection bizline'>" +
          "<span>" + category + " <a href='notRightCategory()' style='font-size:11px;color:#aaa;font-style:italic;'>(Not the right category?)</a></span>" +
        "</div>";
    	}
    	
    	business +=
      "<div class='bizsection bizline'>" +
        "<address><i class='icon-home'></i> <strong>Address: </strong>" + venue.location.address + " " + venue.location.crossStreet + "</address>" +
      "</div>";
      
    
    	getWaitTime(venue.id, function(waitTime) {
    		if (waitTime == -1) {
    			business +=
    			"<div class='bizsection bizline'>" 
    			+ "<span> Estimated Line Length: Currently unavailable.  Feed us some data! </span>" +
    			"</div>";
    		}
    		else {
    			business +=
    			"<div class='bizsection bizline'>" 
    			+ "<p> Estimated line length: " + waitTime +"</p>" +
    			"</div>";
    		}
    		
    		 $('#business').append(business);
    	
    	});
  
    });
  }
    

  $(function () {
      var urlSearch = document.URL.search("\\?")+1;
      if (urlSearch != -1) {
        foursquareId = document.URL.substring(urlSearch);
        console.log(foursquareId);
        prepareToGetFood(foursquareId);
      }
  });


  function addWaitTime(id, numPeople) {
  var ws = new cloudmine.WebService({
    appid: "c74de725f3954f6d9ba3f92489c58ac4",
    apikey: "d15e4a05041741c88acb40e28d9ffc1e"
  });
  
  var currentTime = new Date();
  var uniqueTime = currentTime.getTime();
  var day = currentTime.getDate();
  if (day == 0 || day == 1 || day == 3 || day == 5){
    var dayType = 'MWF';
  }
  else {
    var dayType = 'TH';
  }
  var minutes = currentTime.getMinutes();
  if (minutes < 15) {
    var interval = 'q1';
  } else if (minutes < 30) {
    var interval = 'q2';
  } else if (minutes < 45) {
    var interval = 'q3';
  } else {
    var interval = 'q4';
  }
  
  var dayObject = {};
  var timeObject = {};
  var intervalObject = {};
  timeObject[uniqueTime] = numPeople;
  intervalObject[interval] = timeObject;
  dayObject[dayType] = intervalObject;
  
  ws.update(id, dayObject);

}

function addCategory(id, category) {
  var ws = new cloudmine.WebService({
    appid: "c74de725f3954f6d9ba3f92489c58ac4",
    apikey: "d15e4a05041741c88acb40e28d9ffc1e"
  });
  
  ws.get(id).on('success', function(data, response) {
    var dataObject = data[id];
      
    //if (dataObject.categories){
      var categoryObject = dataObject.categories ? dataObject.categories : {};
      console.log(categoryObject);
      var count = categoryObject[category] ? categoryObject[category] : 0;
      count++;
      categoryObject[category] = count;
      dataObject['categories'] = categoryObject;
    
      ws.update(id, dataObject);
    
  });
  
  ws.get(id).on('error', function(data, response) {
    var dataObject = {};
    var categoryObject = {};
    categoryObject[category] = 1;
    dataObject['categories'] = categoryObject;
    
    ws.update(id, dataObject);
  });
}

function getCategory(id, callback) {
  var ws = new cloudmine.WebService({
      appid: "c74de725f3954f6d9ba3f92489c58ac4",
      apikey: "d15e4a05041741c88acb40e28d9ffc1e"
    });

  ws.get(id).on('success', function(data, response) {
  	alert('success');
    var categories = data[id].categories;
    if (!categories)
    	callback(-1);
    
    var maxCount = 0;
    var max;
    for (x in categories) {
      if (categories[x] >= maxCount){
        max = x;
        maxCount = categories[x];
      }
    }
    callback(max);

  }).on('error', function(data, response) {
  	callback(-1);
  });
}

function getWaitTime(id, callback){
  var ws = new cloudmine.WebService({
      appid: "c74de725f3954f6d9ba3f92489c58ac4",
      apikey: "d15e4a05041741c88acb40e28d9ffc1e"
    });
    
    ws.get(id).on('success', function(data, response) {
      var currentTime = new Date();
      var day = currentTime.getDate();
      if (day == 0 || day == 1 || day == 3 || day == 5){
        var dayType = 'MWF';
      }
      else {
        var dayType = 'TH';
      }
      var minutes = currentTime.getMinutes();
      if (minutes < 15) {
        var interval = 'q1';
      } else if (minutes < 30) {
        var interval = 'q2';
      } else if (minutes < 45) {
        var interval = 'q3';
      } else {
        var interval = 'q4';
      }
      
      var lineCounts = data[id][dayType][interval];
      if (!lineCounts)
      	callback(-1);
      var total = 0;
      var count = 0;
      for (x in lineCounts) {
        total += lineCounts[x];
        count ++;
      }
      callback(total/count);
      
    }).on('error', function(data, response) {
    	callback(-1);
    });
}

window.addEventListener("resize", function() {
    if ($(window).height() < $(window).width()) {
      hideBusinessInfo();
    }
    else {
      hideMenu();
    }
    
  }, false);

  function hideBusinessInfo() {
    $('#business').css('display', 'none');
    $('#menu-layout').css('display','inline');
    var width = $(window).width();
    var height = $(window).height();
    $('#menu').css('width', '100%');
  }

  function hideMenu() {
    $('#menu-layout').css('display','none');
    $('#business').css('display', 'inline');
  }

</script>



    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="assets/js/google-code-prettify/prettify.js"></script>
    <script src="assets/js/bootstrap-transition.js"></script>
    <script src="assets/js/bootstrap-alert.js"></script>
    <script src="assets/js/bootstrap-modal.js"></script>
    <script src="assets/js/bootstrap-dropdown.js"></script>
    <script src="assets/js/bootstrap-scrollspy.js"></script>
    <script src="assets/js/bootstrap-tab.js"></script>
    <script src="assets/js/bootstrap-tooltip.js"></script>
    <script src="assets/js/bootstrap-popover.js"></script>
    <script src="assets/js/bootstrap-button.js"></script>
    <script src="assets/js/bootstrap-collapse.js"></script>
    <script src="assets/js/bootstrap-carousel.js"></script>
    <script src="assets/js/bootstrap-typeahead.js"></script>
    <script src="assets/js/bootstrap-affix.js"></script>
    <script src="assets/js/application.js"></script>

  </body>
</html>
